import _objectWithoutProperties from "@babel/runtime/helpers/objectWithoutProperties";
import _toConsumableArray from "@babel/runtime/helpers/toConsumableArray";
import _objectSpread from "@babel/runtime/helpers/objectSpread";
import _classCallCheck from "@babel/runtime/helpers/classCallCheck";
import _createClass from "@babel/runtime/helpers/createClass";
import _possibleConstructorReturn from "@babel/runtime/helpers/possibleConstructorReturn";
import _getPrototypeOf from "@babel/runtime/helpers/getPrototypeOf";
import _inherits from "@babel/runtime/helpers/inherits";
import _assertThisInitialized from "@babel/runtime/helpers/assertThisInitialized";
import _defineProperty from "@babel/runtime/helpers/defineProperty";

/* eslint-disable react/no-unused-prop-types */
import React, { Component } from 'react';
import FormWrapper from './styled/Form';

var Form =
/*#__PURE__*/
function (_Component) {
  _inherits(Form, _Component);

  function Form(props) {
    var _this;

    _classCallCheck(this, Form);

    _this = _possibleConstructorReturn(this, _getPrototypeOf(Form).call(this, props));

    _defineProperty(_assertThisInitialized(_assertThisInitialized(_this)), "form", void 0);

    _defineProperty(_assertThisInitialized(_assertThisInitialized(_this)), "fields", {
      fieldStates: [],
      validFields: [],
      invalidFields: [],
      isInvalid: false,
      isValidated: false,
      isSubmitted: false
    });

    _defineProperty(_assertThisInitialized(_assertThisInitialized(_this)), "onSubmit", function (event) {
      if (_this.props.onSubmit) {
        _this.props.onSubmit(event);

        event.preventDefault();
        event.stopPropagation();
      }
    });

    _defineProperty(_assertThisInitialized(_assertThisInitialized(_this)), "onValidate", function (event) {
      if (_this.props.onValidate) _this.props.onValidate(event);
    });

    _defineProperty(_assertThisInitialized(_assertThisInitialized(_this)), "initFields", function () {
      return {
        fieldStates: [],
        validFields: [],
        invalidFields: [],
        isInvalid: false,
        isValidated: false,
        isSubmitted: false
      };
    });

    _defineProperty(_assertThisInitialized(_assertThisInitialized(_this)), "getForm", function () {
      var name = _this.state.name;

      var _assertThisInitialize = _assertThisInitialized(_assertThisInitialized(_this)),
          registerField = _assertThisInitialize.registerField,
          unregisterField = _assertThisInitialize.unregisterField,
          getFieldByName = _assertThisInitialize.getFieldByName,
          setFieldState = _assertThisInitialize.setFieldState,
          submit = _assertThisInitialize.submit,
          validate = _assertThisInitialize.validate,
          reset = _assertThisInitialize.reset,
          fields = _assertThisInitialize.fields;

      return {
        name: name,
        fields: fields,
        registerField: registerField,
        unregisterField: unregisterField,
        getFieldByName: getFieldByName,
        setFieldState: setFieldState,
        submit: submit,
        validate: validate,
        reset: reset
      };
    });

    _defineProperty(_assertThisInitialized(_assertThisInitialized(_this)), "registerField", function (fieldState) {
      var prevFields = _objectSpread({}, _this.fields);

      _this.fields = _objectSpread({}, prevFields, {
        fieldStates: _toConsumableArray(prevFields.fieldStates).concat([fieldState])
      });
    });

    _defineProperty(_assertThisInitialized(_assertThisInitialized(_this)), "setFieldState", function (fieldState) {
      var _this$fields = _this.fields,
          fieldStates = _this$fields.fieldStates,
          rest = _objectWithoutProperties(_this$fields, ["fieldStates"]);

      var updatedFieldStates = fieldStates.map(function (obj) {
        return obj.name === fieldState.name ? fieldState : obj;
      });
      _this.fields = _objectSpread({}, rest, {
        fieldStates: updatedFieldStates
      });
    });

    _defineProperty(_assertThisInitialized(_assertThisInitialized(_this)), "unregisterField", function (name) {
      var _this$fields2 = _this.fields,
          fieldStates = _this$fields2.fieldStates,
          rest = _objectWithoutProperties(_this$fields2, ["fieldStates"]);

      var fieldState = fieldStates.find(function (field) {
        return field.name === name;
      });
      _this.fields = _objectSpread({}, rest, {
        fieldStates: fieldStates.splice(fieldStates.indexOf(fieldState))
      });
      return fieldState;
    });

    _defineProperty(_assertThisInitialized(_assertThisInitialized(_this)), "getFieldByName", function (name) {
      return _this.fields.fieldStates.find(function (fieldState) {
        return fieldState.name === name;
      });
    });

    _defineProperty(_assertThisInitialized(_assertThisInitialized(_this)), "submit", function () {
      _this.form.submit();
    });

    _defineProperty(_assertThisInitialized(_assertThisInitialized(_this)), "reset", function () {
      _this.form.reset();
    });

    _defineProperty(_assertThisInitialized(_assertThisInitialized(_this)), "validate", function () {
      var fields = _this.getForm().fields; // Reset our validate results


      fields.invalidFields = [];
      fields.validFields = [];
      fields.isInvalid = false;

      for (var i = 0; i < fields.fieldStates.length; i++) {
        if (fields.fieldStates[i].validate) {
          var validatedFieldState = fields.fieldStates[i].validate();

          if (validatedFieldState.isInvalid) {
            fields.invalidFields.push(fields.fieldStates[i]);
          } else {
            fields.validFields.push(fields.fieldStates[i]);
          }

          fields.isInvalid = !!fields.invalidFields.length;
          fields.isValidated = true;
        }
      } // Update Form validation


      return fields;
    });

    _defineProperty(_assertThisInitialized(_assertThisInitialized(_this)), "renderHeader", function () {});

    _defineProperty(_assertThisInitialized(_assertThisInitialized(_this)), "renderChildren", function () {
      return React.Children.map(_this.props.children, function (child) {
        return React.cloneElement(child, {
          form: _this.getForm()
        });
      });
    });

    _this.state = {
      name: _this.props.name,
      sections: [],
      header: null,
      footer: null
    };
    return _this;
  } // Reference to the form in the DOM so we can call submit, reset...


  _createClass(Form, [{
    key: "componentDidMount",

    /** Extract Header, Footer & Sections */
    value: function componentDidMount() {
      if (this.form) {
        // $FlowFixMe Only for dev preview. TODO: resolve this type error
        this.form.addEventListener('submit', this.onSubmit);
      }
    }
  }, {
    key: "componentWillUnmount",
    value: function componentWillUnmount() {
      if (this.form) {
        // $FlowFixMe Only for dev preview. TODO: resolve this type error
        this.form.removeEventListener('submit', this.onSubmit);
      }
    } // EVENT HANDLERS

  }, {
    key: "render",

    /** The bulk of the rendering & layout for the forms childrens is done when the component mounts.
     * We inject references to the form via cloneElement
     */
    value: function render() {
      var _this2 = this;

      var _this$props = this.props,
          action = _this$props.action,
          encType = _this$props.encType,
          method = _this$props.method,
          name = _this$props.name,
          target = _this$props.target,
          accept = _this$props.accept,
          acceptCharset = _this$props.acceptCharset,
          autoComplete = _this$props.autoComplete;
      return React.createElement(FormWrapper, null, React.createElement("form", {
        action: action,
        encType: encType,
        method: method,
        name: name,
        target: target,
        accept: accept,
        acceptCharset: acceptCharset,
        autoComplete: autoComplete // $FlowFixMe Only for dev preview. TODO: resolve this type error
        ,
        ref: function ref(form) {
          _this2.form = form;
        }
      }, this.renderChildren()));
    }
  }]);

  return Form;
}(Component);

_defineProperty(Form, "defaultProps", {
  target: '_self'
});

export { Form as default };